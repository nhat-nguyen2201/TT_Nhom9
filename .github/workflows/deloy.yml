name: Deploy to CloudFly VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    # ===== BUILD FRONTEND =====
    - name: Build Frontend
      run: |
        set -e
        echo "Node version:"
        node -v

        cd frontend
        rm -rf node_modules package-lock.json
        npm install
        npm run build

        echo "Build result:"
        ls -la dist

    # ===== COPY FILES =====
    - name: Copy files to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        source: "backend,frontend/dist"
        target: "/var/www/my-website"
        overwrite: true

    # ===== INSTALL & RESTART BACKEND =====
    - name: Install & Restart Backend
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        script: |
          set -e
          echo "Current directory:"
          pwd

          cd /var/www/my-website/backend

          echo "Files in backend:"
          ls -la

          echo "Install dependencies"
          npm ci --omit=dev

          echo "Restart PM2"
          pm2 reload backend-api || pm2 start server.js --name backend-api

          pm2 status
          echo "DEPLOY SUCCESS"
